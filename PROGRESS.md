# LaserConvert IGES Parser - Progress Summary

## What We've Accomplished

### ? Core Infrastructure
- **IGES File Loading**: Successfully loads IGES files using IxMilia.Iges library
- **Entity Recovery**: Implemented two-pass entity loading:
  - Pass 1: Create all entities and register them in binder with **1-based directory indices** (matching IGES pointer convention)
  - Pass 2: Bind pointers and call OnAfterRead() with all entities available
  - Pass 3: Flush remaining entity bindings
- **Shell & Face Recovery**: Added logic to recover Shell and Face entities when initial binding fails
- **Manifest Binding**: Recovered IgesManifestSolidBRepObject binding to shells

### ? New Entity Support Added to IxMilia.Iges
- `IgesFace` (type 508) - with Surface and Loops properties
- `IgesLoop` (type 510) - with Curves list and IsOuter flag  
- `IgesShell` (type 514) - with Faces list

### ? SVG Generation Infrastructure
- SVG builder with groups, paths, and style support
- Plane frame calculations for 2D projection
- Face classification (outer vs inner loops)
- Line, arc, and NURBS curve sampling/tessellation
- Complete pipeline from IGES ? Solids ? Faces ? Loops ? SVG paths

### ? Test Case Working
- Loads `jasonbox only.igs` successfully
- Identifies 6 faces in the shell
- Creates SVG group with name "JASONBOX"
- **Issue**: SVG group is empty (no geometry paths generated)

## The Problem: Non-Standard IGES Topology

### What We Found
The Plasticity-generated IGES file uses **non-standard topology**:

**Standard IGES topology should be:**
```
Face (508) ? Loop (510) ? Edges (110: Lines, 123: Arcs, etc.)
```

**Plasticity's topology is:**
```
Face (508) ? Loop (510) ? [Face pointers?]
           ?
        [No usable edge data]
```

### Loop Parameters Analysis
Example: `510,35,1,1,37,0,0;`
- Currently interpreted as: curveCount=35, then 35 curve pointers
- Only 6 parameters available total
- Pointers 1 and 37 ? pointer 37 resolves to another Face (type 508)
- Pointer 1 ? resolves to null (doesn't exist)

### Face Parameters Analysis
Example: `508,4,0,27,1,0,0,0,27,2,0,0,0,27,3,0,0,0,27,4,0,0,0,0;`
- Repeated pattern: `27,X,0,0,0` where X varies (1,2,3,4...)
- Unclear if these are pointers to lines or embedded geometry descriptions
- All faces have same surface pointer (4) which doesn't exist

## Current State of Code

### Files Modified in IxMilia.Iges:
1. **IgesFileReader.cs** - Two-pass loading with 1-based directory indexing
2. **IgesEntity_FromData.cs** - Added Face and Loop entity creation
3. **IgesFace.cs** - NEW: Stores surface and loops
4. **IgesLoop.cs** - NEW: Stores curve entities
5. **IgesShell.cs** - NEW/MODIFIED: Added faces list support
6. **IgesManifestSolidBRepObject.cs** - Face binding recovery

### Files Modified in LaserConvert:
1. **Program.cs** - Complete SVG generation pipeline with:
   - IGES file loading
   - Solid identification
   - Face ? Loop ? Edge ? SVG path conversion
   - Fallback mechanisms for missing geometry

## What's Needed to Move Forward

### Option 1: Reverse-Engineer Plasticity Format
Need to understand:
- What do Loop parameters `35,1,1,37,0,0` actually mean?
- What do Face parameters `4,0,27,1,0,0,0,27,2...` represent?
- Are the `27,X` values line pointers or something else?
- Is there actual geometry data embedded in parameters or are all pointers broken?

### Option 2: Extract Geometry from Available Data
- Face parameters might encode edge topology directly
- Could parse Face as a boundary representation without loops
- Lines (110) in the directory have full geometry - could match them to faces by proximity/orientation

### Option 3: Use HOOPS Exchange Documentation
- File header says "File generated by HOOPS Exchange Version 24.2.0"
- HOOPS has its own IGES export format/conventions
- May have specific documentation or code that handles this format

## Key Learning: Entity Registration Fix

**Critical discovery**: IGES pointers are 1-based directory entry numbers:
- DirectoryEntry 0 ? pointer 1
- DirectoryEntry 1 ? pointer 2
- etc.

But IxMilia was registering by `SequenceNumber` which is always 0. Fixed by using:
```csharp
int pointerKey = directoryIndex + 1;
binder.EntityMap[pointerKey] = entity;
```

## Files Generated
- `jasonbox_output.svg` - Generated but empty (6 faces found, no geometry extracted)
- Current build: Successful, no compilation errors

## Next Steps Recommendation
1. Add detailed logging to IgesLoop/IgesFace ReadParameters to understand actual data
2. Compare with standard IGES Loop/Face specifications
3. Extract geometry directly from Face parameters if loop approach fails
4. Consider reaching out to HOOPS or Plasticity for format documentation
