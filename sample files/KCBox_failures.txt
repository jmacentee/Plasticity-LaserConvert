KCBox TEST CASE - FAILED APPROACHES AND LESSONS LEARNED
========================================================

OVERVIEW:
KCBox.stp contains a complex solid with 32 boundary vertices on the outer edge, 
with tabs/cutouts along the perimeter and 2 interior holes. The challenge is 
extracting and rendering all 32 vertices of the outline, not a simplified convex 
hull approximation.

EXPECTED OUTPUT:
- Overall width: 40mm
- Overall height: 58mm (including tabs at top and bottom)
- Left side: 50mm (without tabs)
- Outline: Complex polygon with 32 vertices showing all tabs and cutouts
- Holes: 2 holes (10x10 at 5mm from top/left, and a smaller hole)
- All rendered in SVG with black outline and red holes

FAILED APPROACHES:
================

1. GRAHAM SCAN / CONVEX HULL ORDERING
   ATTEMPTED: Apply Graham scan (polar angle sorting) to order vertices for complex shapes
   RESULT: Collapsed 32 vertices to ~12 convex hull vertices
   REASON: Graham scan is designed to produce convex hull, removes interior/concave vertices
   ISSUE: Lost all tab and cutout detail - the shape became a simplified polygon
   COMMIT: Multiple commits tried Graham scan as fallback for orthogonal sort failures
   
   LESSON: Never use convex hull algorithms for non-convex polygons. The goal is to preserve
   ALL boundary vertices, not simplify them.

2. UNIFORM DEDUPLICATION FOR ALL SHAPES
   ATTEMPTED: Dedup all shapes equally - remove consecutive duplicate points at high precision
   RESULT: KCBox 34 raw vertices became 18 points, still with jumping/backtracking
   REASON: Dedup after projection to 2D broke the sequential perimeter order
   ISSUE: Vertices appeared in wrong order from bounds extraction, dedup removed data
   
   LESSON: Don't dedup all shapes the same way. Complex shapes need all vertices preserved.

3. POLAR ANGLE FROM CENTROID SORTING
   ATTEMPTED: Sort deduplicated points by polar angle from centroid
   RESULT: Still collapsed non-convex vertices and created wrong ordering
   REASON: Centroid-based angle sorting doesn't preserve perimeter for non-convex shapes
   ISSUE: Same problem as Graham scan - loses interior vertices
   
   LESSON: Polar angle sorting is fundamentally unsuitable for non-convex polygons.

4. TRUSTING DEDUP ORDER FROM BOUNDS EXTRACTION
   ATTEMPTED: After orthogonal sort failed, use the dedup order as-is
   RESULT: Path had backtracking, duplicate points, and wrong connections
   ISSUE: Bounds extraction order doesn't guarantee perimeter traversal
   PROBLEM: The 34 raw 3D vertices from ExtractFaceWithHoles jump around;
            dedup removes consecutive duplicates but leaves non-sequential ordering
   
   LESSON: Dedup order doesn't preserve perimeter order. The raw vertex sequence from
   bounds extraction is not in proper perimeter traversal order.

5. ORTHOGONAL NEAREST-NEIGHBOR ONLY
   ATTEMPTED: Use SortPerimeterVertices2D for all complex shapes
   RESULT: Failed to connect non-orthogonal vertices (orthogonal constraint too strict)
   REASON: Requires vertices to share X or Y coordinates; KCBox has diagonal edges
   
   LESSON: Orthogonal sort only works for axis-aligned shapes. Can't be used alone for
   complex non-orthogonal geometry.

6. DEDUP THEN ORDER APPROACH
   ATTEMPTED: Dedup vertices first, then apply ordering algorithm
   RESULT: Lost information during dedup; ordering can't recover missing vertices
   REASON: Dedup reduces 34 -> 18, can't reverse the process
   
   LESSON: Must ORDER first, then dedup only if needed. Reversing this order loses data.

7. SELECTING FACE BY MOST VERTICES (KCBoxFlat issue)
   ATTEMPTED: For complex shapes, pick face with most boundary vertices from ExtractFaceWithHoles
   RESULT: KCBoxFlat got 32-vertex face with Y=0 range (degenerate 1D edge)
   REASON: ExtractFaceWithHoles returns vertices from EDGE TOPOLOGY, not 2D face geometry
   ISSUE: Selected face has complex edge structure but zero height in projected dimension
           The 32 vertices from edge loops don't form a proper 2D outline
   
   LESSON: ExtractFaceWithHoles returns edge topology vertices, not face surface vertices.
   For flat shapes, edge topology can be degenerate (1D lines instead of 2D outlines).
   Can't use most-vertices heuristic - need a better face selection method.

8. DYNAMIC AXIS SELECTION FOR 2D PROJECTION (KCBoxFlat partial fix)
   ATTEMPTED: Detect which two axes have largest variance and use those for projection
   RESULT: KCBoxFlat correctly identified X and Z axes, but outline still Y=0
   REASON: The underlying vertex data (from edge topology) only spans one dimension
   ISSUE: Even with correct axis selection, if vertices are all Y=0, projection has no content
   
   LESSON: Axis selection is necessary but not sufficient. The real problem is that
   the face vertices themselves are degenerate (extracted from 1D edge topology).
   Need to fix the vertex extraction, not just the projection axes.

CURRENT INVESTIGATION - KCBoxFlat ROOT CAUSE:
==============================================

DISCOVERED ISSUE:
KCBoxFlat outline vertices have Y=0 range because they're from edge topology, not face geometry.

EVIDENCE FROM LOGS:
[SVG] KCBoxFlat: Outline vertices after rotation - X:[-0.0,40.1] Y:[-3.0,-3.0] Z:[-58.4,-0.2]

All Y values are -3.0 (single value = degenerate). Meanwhile:
- X ranges 0 to 40 (correct)
- Z ranges -58.4 to -0.2 (correct - this is the 58mm height)
- Y is constant -3.0 (this is just the 3mm thickness)

WHAT'S HAPPENING:
1. We selected the right face (32 vertices with complex outline)
2. But ExtractFaceWithHoles returns vertices from the EDGE LOOPS of that face
3. For KCBoxFlat, which is a flat extrusion, these edge loops are 1D lines on the edges
4. A 1D edge has zero extent in the perpendicular direction
5. Result: All extracted Y values are the same (degenerate)

WHY ExtractFaceWithHoles IS THE PROBLEM:
The function extracts vertices from StepFaceBound -> StepEdgeLoop -> StepOrientedEdge chains.
This traverses the BOUNDARY of the face, not the SURFACE of the face.
For a flat extrusion (top surface), the boundary is a 1D curve with no extent perpendicular to it.

THE REAL SOLUTION:
Instead of using ExtractFaceWithHoles (which returns edge topology), we need to:
1. Extract ALL unique vertices from the face's bounds (the corners/keypoints of the loops)
2. Project them to 2D
3. Reconstruct the perimeter by ordering them correctly around the boundary

OR:

Get the actual face normal and extract vertices that lie ON that face plane,
rather than following edge topology.

CURRENT PARTIAL SUCCESS:
======================

Tests 1-8 (simple shapes): PASS
- Box1, Box2, etc all render correctly with 4-vertex rectangles
- CBox and CBoxR render correctly with holes
- KBox renders with 12 vertices (partial - may be missing detail)

KCBox (rotated complex shape): PARTIAL
- Renders with 34 vertices from face with 3 bounds
- Has both holes rendered
- But outline ordering may be wrong (uses dedup order, not proper perimeter order)

KCBoxFlat (flat complex shape): FAIL
- Extracts 32 vertices but they're all at Y=-3 (degenerate)
- Cannot render proper outline because outline is collapsed

NEXT WORK ITEM:
The fix for KCBoxFlat requires addressing the root cause:
ExtractFaceWithHoles returns degenerate vertices for flat faces.

Options:
A. Detect degenerate faces (zero extent in one axis) and handle specially
B. Extract vertices differently for flat/complex shapes
C. Use face plane equations to find properly distributed vertices
D. Post-process: detect zero ranges and recover missing dimension from face bounds

Most practical: Option A - detect when extracted vertices are degenerate and
fall back to extracting vertices from ALL face bounds directly (not just outer loop).
